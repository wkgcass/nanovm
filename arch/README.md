# 架构说明

总体来说，Nanovm会依照JVM进行设计，并且使用jvm字节码的一个子集。  
不过，我们并不想做一个完整的JVM，只是利用已有的规范而已。

## 模块划分

Nanovm分为如下模块:

VM层

1. Code manager: 将字节码读入内存，并管理方法区
2. Stack manager: 从方法区获取字节码，并管理栈帧以及局部变量
3. Memory manager: 管理对象的生命周期。Nanovm只使用引用计数做gc
4. Native manager: 定义c和客户的代码的交互数据结构，并将客户端方法映射到native方法
5. Thread manager: 管理线程创建和销毁

SDK层

1. nanovm.string: 字符串类型，和java干的不一样，全部使用native方法，直接封装到底层去处理
2. nanovm.syscall: 系统调用函数，类型系统保护的api仅提供可跨平台的选项，但提供扩展点可以设置
3. nanovm.console: 控制台输入输出相关
4. nanovm.os: 操作系统相关，例如线程等
5. nanovm.lang: 语言扩展，例如free函数

## 简易图示

```
BYTECODE{CAFEBABE...}
         |
+--------|-----------------------------------------------------------------------------+
|        |                                 NanoVM                                      |
|        |                                                                             |
|        |                                                                             |
|        |                                                                             |
|        |                                                                             |
|        |                 +-----------------+       +------------------------------+  |
|        |                 |   Code manager  |       |       Stack manager          |  |
|        |                 | +-----+ +-----+ |       | +--------------------------+ |  |
|        +------------------>|class| |class| |       | |          Stack           | |  |
|                          | |field| |field| |       | | +----------------------+ | |  |
|                          | |meth | |meth -----+------------->   Frame         | | |  |
|                          | +-----+ +-----+ |  |    | | | +--------+ +-------+ | | |  |
|                          +-----------------+  |    | | | |opstack | | vars  | | | |  |
|                                               |    | | | +--------+ +-------+ | | |  |
|                                               |    | | +----------------------+ | |  |
|        +-----------------------------------+  |    | +--------------------------+ |  |
|        |           Memory manager          |  |    +------------------------------+  |
|        |     controls all allocations      |  |                                      |
|        +-----------------------------------+  |                                      |
|        +-----------------------------------+  |                                      |
|        |           Thread manager          |  |    +------------------------+        |
|        |                                   |  +--->|     Native manager     |        |
|        +-----------------------------------+       +------------------------+        |
|                                                                                      |
+--------------------------------------------------------------------------------------+
```
